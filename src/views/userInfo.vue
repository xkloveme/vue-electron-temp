<template>
  <div style="text-align: center;">
    <h2>
      Êä•Âëä‰∫∫Âü∫Êú¨ÊÉÖÂÜµ
      <el-tooltip
        class="item"
        content="ËØ¥ÊòéÔºö‚ë†Â∑•‰ΩúÂπ¥Èôê‰ª•Âπ¥‰∏∫Âçï‰Ωç„ÄÇ‚ë°Ë∫´‰ªΩËØÅÂè∑Á†ÅÂ∫îÂ°´ÂÜô18‰ΩçÂÖ¨Ê∞ëË∫´‰ªΩÂè∑Á†Å„ÄÇ‚ë¢È¢ÜÂØºÂ≤ó‰ΩçÂ°´ÂàÜÁÆ°Â∑•‰ΩúÔºåÈùûÈ¢ÜÂØºÂ≤ó‰ΩçÂ°´‰ªé‰∫ãÁöÑ‰∏ªË¶ÅÂ∑•‰Ωú„ÄÇ"
        effect="dark"
      >
        <i class="el-icon-question" />
      </el-tooltip>
    </h2>
    <div>
      <el-form :model="form" :rules="rules" label-width="120px" ref="form">
        <el-row :gutter="0">
          <el-col :span="6">
            <el-form-item label="ÂßìÂêç" prop="name">
              <el-input v-model="form.name" />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="ÊÄßÂà´">
              <el-select clearable filterable placeholder="ËØ∑ÈÄâÊã©" v-model="form.gender">
                <el-option :key="item" :label="item" :value="i" v-for="(item,i) in $utils.gender" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="Ê∞ëÊóè">
              <el-select placeholder="ËØ∑ÈÄâÊã©" v-model="form.nation">
                <el-option :key="item" :label="item" :value="item" v-for="item in $utils.nation" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="ÊîøÊ≤ªÈù¢Ë≤å">
              <el-select placeholder="ËØ∑ÈÄâÊã©" v-model="form.politicsStatus">
                <el-option
                  :key="item"
                  :label="item"
                  :value="i"
                  v-for="(item,i) in $utils.politicsStatus"
                />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-col :span="12">
            <el-form-item label="Ë∫´‰ªΩËØÅÂè∑" prop="idCard">
              <el-input v-model="form.idCard" />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="ËÅîÁ≥ªÁîµËØù">
              <el-input v-model="form.phone" />
            </el-form-item>
          </el-col>
          <el-col :span="6">
            <el-form-item label="‰ªé‰∫ãÊàñÂàÜÁÆ°Â∑•‰Ωú">
              <el-input v-model="form.work" />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="10">
          <el-col :span="20">
            <el-col :span="12">
              <el-form-item label="Â∑•‰ΩúÂçï‰Ωç">
                <el-select
                  clearable
                  filterable
                  placeholder="ËØ∑ÈÄâÊã©"
                  style="width:100%"
                  v-model="form.employer"
                >
                  <el-option
                    :key="item.key"
                    :label="item.value"
                    :value="item.key"
                    v-for="item in $utils.workOrganization"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Áé∞‰ªªËÅåÂä°">
                <el-input v-model="form.duty" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Â∑•‰ΩúÈÉ®Èó®">
                <el-input v-model="form.department" />
              </el-form-item>
              <el-form-item label="ÂÖ•ÂÖöÊó∂Èó¥">
                <el-date-picker
                  placeholder="ÈÄâÊã©Âπ¥Êúà"
                  style="width:100%"
                  type="month"
                  v-model="form.partyTime"
                  value-format="timestamp"
                />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Âú®ËÅåÁä∂ÊÄÅ">
                <el-select
                  clearable
                  filterable
                  placeholder="ËØ∑ÈÄâÊã©"
                  style="width:100%"
                  v-model="form.workingStatus"
                >
                  <el-option
                    :key="item"
                    :label="item"
                    :value="i"
                    v-for="(item,i) in $utils.workingStatus"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="Â∑•‰ΩúÂπ¥Èôê(Âπ¥)">
                <el-input placeholder="Â∑•‰ΩúÂπ¥Èôê(Âπ¥)" v-model="form.workingYears" />
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ËÅåÁ∫ß">
                <el-select
                  clearable
                  filterable
                  placeholder="ËØ∑ÈÄâÊã©"
                  style="width:100%"
                  v-model="form.grade"
                >
                  <el-option
                    :key="item.key"
                    :label="item.value"
                    :value="item.key"
                    v-for="item in $utils.grade"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ËÅå‰Ωç">
                <el-select
                  clearable
                  filterable
                  placeholder="ËØ∑ÈÄâÊã©"
                  style="width:100%"
                  v-model="form.position"
                >
                  <el-option
                    :key="item.key"
                    :label="item.value"
                    :value="item.key"
                    v-for="item in $utils.position"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="‰∫∫ÂëòÊù•Ê∫ê">
                <el-select
                  clearable
                  filterable
                  placeholder="ËØ∑ÈÄâÊã©"
                  style="width:100%"
                  v-model="form.personnelSource"
                >
                  <el-option
                    :key="item.key"
                    :label="item.value"
                    :value="item.key"
                    v-for="item in $utils.personnelSource"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col :span="12">
              <el-form-item label="ÂØπË±°Ë∫´‰ªΩ">
                <el-select
                  clearable
                  filterable
                  placeholder="ËØ∑ÈÄâÊã©"
                  style="width:100%"
                  v-model="form.objectIdentity"
                >
                  <el-option
                    :key="item.key"
                    :label="item.value"
                    :value="item.key"
                    v-for="item in $utils.objectIdentity"
                  />
                </el-select>
              </el-form-item>
            </el-col>
            <el-col>
              <el-form-item label="‰∫∫ÂëòË∫´‰ªΩ">
                <el-checkbox-group v-model="form.identity">
                  <el-checkbox :key="i+1" :label="item" v-for="(item,i) in $utils.identity" />
                </el-checkbox-group>
              </el-form-item>
            </el-col>
          </el-col>
          <el-col :span="4">
            <input
              @change="handleAvatarSuccess"
              accept="image/*"
              ref="input"
              style="display:none"
              type="file"
            />
            <div class="avatar-uploader">
              <el-image
                :src="form.imageUrl"
                @click="$refs.input.click()"
                class="avatar"
                fit="fit"
                v-if="form.imageUrl"
              >
                <div class="image-slot" slot="error">
                  <i class="el-icon-picture-outline" />
                </div>
              </el-image>
              <i @click="$refs.input.click()" class="el-icon-plus" v-else />
            </div>
          </el-col>
        </el-row>

        <el-form-item label="Êà∑Á±çÂú∞ÂùÄ">
          <el-input v-model="form.householdRegistration" />
        </el-form-item>
        <el-form-item label="Áé∞Â±Ö‰ΩèÂú∞">
          <el-input v-model="form.currentResidence" />
        </el-form-item>
        <el-row>
          <el-col :span="12">
            <el-form-item label="ÂØÜÁ†Å" prop="password">
              <el-input
                :type="passType?'password':'text'"
                autocomplete="off"
                v-model="form.password"
              >
                <el-button @click="passType=!passType" icon="el-icon-view" slot="append" />
              </el-input>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Á°ÆËÆ§ÂØÜÁ†Å" prop="checkPassword">
              <el-input
                :type="checkPassType?'password':'text'"
                autocomplete="off"
                v-model="form.checkPassword"
              >
                <el-button @click="checkPassType=!checkPassType" icon="el-icon-view" slot="append" />
              </el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-form-item label="‰∏™‰∫∫ÁÆÄÂéÜ">
          <el-input
            :autosize="{ minRows: 4, maxRows: 6 }"
            type="textarea"
            v-model="form.personalResume"
          />
        </el-form-item>
        <!-- <el-form-item>
          <el-button @click="onSubmit" type="primary">Á´ãÂç≥ÂàõÂª∫</el-button>
          <el-button>ÂèñÊ∂à</el-button>
        </el-form-item>-->
      </el-form>
    </div>
    <!-- <networking /> -->
  </div>
</template>

<script>
// import networking from './networking'
// import {db} from './../db.js'
var JSZip = require('jszip')
const fs = require('fs')
export default {
  // components: { networking },
  data() {
    var validatePass = (rule, value, callback) => {
      if (value === '') {
        callback()
      } else {
        if (this.form.checkPass !== '') {
          this.$refs.form.validateField('checkPass')
        }
        callback()
      }
    }
    var validatePass2 = (rule, value, callback) => {
      if (value !== this.form.password) {
        callback(new Error('‰∏§Ê¨°ËæìÂÖ•ÂØÜÁ†Å‰∏ç‰∏ÄËá¥!'))
      } else {
        callback()
      }
    }
    return {
      passType: true,
      checkPassType: true,
      rules: {
        name: [{ required: true, message: 'ËØ∑Â°´ÂÜôÂßìÂêç', trigger: 'blur' }],
        idCard: [
          { required: true, message: 'ËØ∑Â°´ÂÜôË∫´‰ªΩËØÅÂè∑', trigger: 'blur' },
        ],
        password: [{ validator: validatePass, trigger: 'blur' }],
        checkPassword: [{ validator: validatePass2, trigger: 'blur' }],
      },
    }
  },
  computed: {
    form() {
      return this.$store.getters.getUser
    },
  },
  mounted() {
    // ÁõëÂê¨‰∏é‰∏ªËøõÁ®ãÁöÑÈÄö‰ø°
    this.$ipc.on('action', (event, arg) => {
      switch (arg) {
        case 'open': // ÊâìÂºÄÊñá‰ª∂
          console.log('open')
          this.loadAsyncZip()
          break
        case 'about': // ÂÖ≥‰∫é
          console.log('about')
          break
        case 'save': // ‰øùÂ≠ò
          this.downloadZip()
          break
        case 'new': // Êñ∞Âª∫
          this.openNew()
          console.log('new')
          break
      }
    })
  },
  methods: {
    openDialogByIpc() {
      this.$ipc.send('showDialog', `<${this.$t('a message')}>`)
    },
    openNew() {
      this.$store.dispatch('updateUser', null)
    },
    onSubmit() {
      this.$refs.form.validate((valid) => {
        if (valid) {
          console.log('submit!', this.form)
        } else {
          this.$message({
            type: 'error',
            message: 'ËØ∑Ê£ÄÊü•ËæìÂÖ•ÊòØÂê¶ÊúâËØØ',
          })
          return false
        }
      })
    },
    // ÂõæÁâá‰∏ä‰º†
    handleAvatarSuccess(e) {
      var file = e.target.files[0] // Ëé∑ÂèñÂõæÁâáËµÑÊ∫ê
      const self = this
      // Âè™ÈÄâÊã©ÂõæÁâáÊñá‰ª∂
      if (!file.type.match('image.*')) {
        return false
      }

      var reader = new FileReader()

      reader.readAsDataURL(file) // ËØªÂèñÊñá‰ª∂

      // Ê∏≤ÊüìÊñá‰ª∂
      reader.onload = function (arg) {
        console.log(arg.target.result)
        self.form.imageUrl = arg.target.result
      }
    },
    downloadZip() {
      this.$refs.form.validate((valid) => {
        if (valid) {
          const self = this
          // ÂàùÂßãÂåñ‰∏Ä‰∏™zipÊâìÂåÖÂØπË±°
          var zip = new JSZip()
          // ÂàõÂª∫‰∏Ä‰∏™Ë¢´Áî®Êù•ÊâìÂåÖÁöÑÊñá‰ª∂
          zip.file('user.json', JSON.stringify(this.form))
          if (this.form.password) {
            zip.file('password', this.form.password)
          }
          // ÂàõÂª∫‰∏Ä‰∏™Âêç‰∏∫imagesÁöÑÊñ∞ÁöÑÊñá‰ª∂ÁõÆÂΩï
          // var img = zip.folder('images')
          // Ëøô‰∏™imagesÊñá‰ª∂ÁõÆÂΩï‰∏≠ÂàõÂª∫‰∏Ä‰∏™base64Êï∞ÊçÆ‰∏∫imgDataÁöÑÂõæÂÉèÔºåÂõæÂÉèÂêçÊòØsmile.gif
          // img.file('smile.gif', imgData, { base64: true })
          // ÊääÊâìÂåÖÂÜÖÂÆπÂºÇÊ≠•ËΩ¨Êàêblob‰∫åËøõÂà∂Ê†ºÂºè
          zip.generateAsync({ type: 'blob' }).then(function (content) {
            var filename = self.form.name + self.form.idCard + '.wt'
            // ÂàõÂª∫ÈöêËóèÁöÑÂèØ‰∏ãËΩΩÈìæÊé•
            var eleLink = document.createElement('a')
            eleLink.download = filename
            eleLink.style.display = 'none'
            // ‰∏ãËΩΩÂÜÖÂÆπËΩ¨ÂèòÊàêblobÂú∞ÂùÄ
            eleLink.href = URL.createObjectURL(content)
            // Ëß¶ÂèëÁÇπÂáª
            document.body.appendChild(eleLink)
            eleLink.click()
            // ÁÑ∂ÂêéÁßªÈô§
            document.body.removeChild(eleLink)
          })
        } else {
          this.$message({
            type: 'error',
            message: 'ËØ∑Ê£ÄÊü•ËæìÂÖ•ÊòØÂê¶ÊúâËØØ',
          })
          return false
        }
      })
    },
    loadAsyncZip(defaultpath, callback) {
      const self = this
      const files = this.$dialog.showOpenDialog({
        filters: [{ name: 'WT', extensions: ['wt'] }],
        properties: ['openFile'],
      })
      if (files) {
        files.then((res) => {
          // const buf = Buffer.alloc(1024)
          const path = res.filePaths[0]
          fs.readFile(path, function (err, data) {
            if (err) throw err
            JSZip.loadAsync(data).then(function (zip) {
              console.log('üêõ:: loadAsyncZip -> zip', zip, zip.files)
              if (zip.files && zip.files.password) {
                zip.files.password.async('text').then((pwd) => {
                  self
                    .$prompt('ËØ∑ËæìÂÖ•Êñá‰ª∂ÂØÜÁ†Å', 'ÂØÜÁ†ÅËæìÂÖ•', {
                      confirmButtonText: 'Á°ÆÂÆö',
                      cancelButtonText: 'ÂèñÊ∂à',
                    })
                    .then(({ value }) => {
                      if (String(value) === String(pwd)) {
                        self.$message({
                          type: 'success',
                          message: 'ÂØÜÁ†ÅÊ≠£Á°Æ',
                        })
                        zip.files['user.json'].async('text').then((res) => {
                          self.getJson(res)
                        })
                      } else {
                        self.$message({
                          type: 'error',
                          message: 'ÂØÜÁ†ÅÈîôËØØ',
                        })
                      }
                    })
                    .catch(() => {
                      self.$message({
                        type: 'info',
                        message: 'ÂèñÊ∂àËæìÂÖ•',
                      })
                    })
                })
              } else {
                zip.files['user.json'].async('text').then((res) => {
                  self.getJson(res)
                })
              }
            })
          })
        })
      }
    },
    getJson(text) {
      if (text) {
        const jsonData = JSON.parse(text)
        console.log(jsonData)
        this.$store.dispatch('updateUser', jsonData)
      }
    },
  },
}
</script>

<style>
.home-button {
  background-color: #263238;
  opacity: 1;
  border-radius: 4px;
  cursor: pointer;
  height: 45px;
  width: 150px;
  margin: 10px 10px;
  text-align: center;
  line-height: 45px;
}
.avatar-uploader {
  border: 1px dashed #d9d9d9;
  border-radius: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  height: 260px;
  line-height: 260px;
}
.avatar-uploader:hover {
  border-color: #409eff;
}
.avatar-uploader-icon {
  font-size: 28px;
  color: #8c939d;
  width: 178px;
  height: 178px;
  line-height: 178px;
  text-align: center;
}
.avatar {
  display: block;
}
</style>
